#!/usr/bin/env bash

set -Eeuo pipefail

get_legacy_version() {
  local -r version_file="$1"
  local -r supported_plugins=(terraform packer)

  # check if current plugin is supported and with a readable legacy file
  for plugin in "${supported_plugins[@]}"; do
    if [[ ${version_file} == *".${plugin}-version" && -r ${version_file} ]]; then
      cat "${version_file}"
    fi
  done

  if [[ "${version_file}" =~ "main.tf"  ]]; then
    grep --no-filename \
         --recursive \
         --fixed-strings \
         --exclude-dir .terraform \
         required_version \
         "$(dirname "${version_file}")" \
      | sed -e 's/required_version\s*=\s*"=\(.*\)"/\1/' \
      | tr -d ' '
  fi
}

get_legacy_version "$1"
